<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Console</title>
<style>
body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;margin:24px;max-width:900px}
h1{font-size:20px;margin:0 0 12px}
label{display:block;margin:12px 0 4px;font-weight:600}
input,textarea,button,select{font:inherit}
input[type=text],textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
textarea{min-height:110px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
button{padding:10px 14px;border:1px solid #111;background:#111;color:#fff;border-radius:8px;cursor:pointer}
button.secondary{background:#fff;color:#111}
pre{background:#0b1020;color:#d8e1ff;padding:12px;border-radius:8px;white-space:pre-wrap;word-break:break-word}
.small{font-size:12px;color:#666}
hr{border:none;height:1px;background:#eee;margin:20px 0}
.badge{padding:2px 6px;border:1px solid #ccc;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<h1>Admin Console <span id="status" class="badge">checking…</span></h1>

<div class="row">
  <div style="flex:1 1 280px">
    <label>Base URL</label>
    <input id="base" type="text" value="">
    <div class="small">Example: https://whatsappbot-7agd.onrender.com</div>
  </div>
  <div style="flex:1 1 280px">
    <label>Admin Token</label>
    <input id="token" type="text" placeholder="Bearer token">
    <div class="small">Your ADMIN_TOKEN (not stored on server)</div>
  </div>
</div>

<hr>

<div>
  <label>New KB Content</label>
  <textarea id="content" placeholder="Paste text…"></textarea>
  <label>Meta (JSON)</label>
  <input id="meta" type="text" value='{"src":"console"}'>
  <div class="row" style="margin-top:10px">
    <button id="btn-insert">Insert KB Row</button>
    <button id="btn-count" class="secondary">Count</button>
    <button id="btn-list" class="secondary">List 5</button>
    <button id="btn-diag" class="secondary">__diag</button>
  </div>
</div>

<hr>
<pre id="out">Ready.</pre>

<script>
const $ = id => document.getElementById(id);
function b(){ return ($("base").value || "").replace(/\/+$/,""); }
function t(){ return $("token").value.trim(); }
function hdr(){ return { "Authorization": "Bearer " + t(), "Content-Type": "application/json" }; }
function show(x){ $("out").textContent = typeof x==="string" ? x : JSON.stringify(x,null,2); }

async function ping(){
  try{
    const r = await fetch(b()+"/__diag");
    const j = await r.json();
    $("status").textContent = j.db_ok ? "db:ok" : "db:fail";
  }catch(e){ $("status").textContent = "offline"; }
}

$("btn-diag").onclick = async ()=>{
  const r = await fetch(b()+"/__diag");
  show(await r.json());
};

$("btn-count").onclick = async ()=>{
  const r = await fetch(b()+"/admin/kb/count",{headers:{Authorization:"Bearer "+t()}});
  show(await r.json());
};

$("btn-list").onclick = async ()=>{
  const r = await fetch(b()+"/admin/kb/list?limit=5",{headers:{Authorization:"Bearer "+t()}});
  show(await r.json());
};

$("btn-insert").onclick = async ()=>{
  const content = $("content").value.trim();
  if(!content){ show("content required"); return; }
  let meta = {};
  const mv = $("meta").value.trim();
  try{ if(mv) meta = JSON.parse(mv); }catch(e){ show("meta must be JSON"); return; }
  const r = await fetch(b()+"/admin/kb",{method:"POST", headers:hdr(), body:JSON.stringify({content, meta})});
  const j = await r.json();
  show(j);
};

(function init(){
  const loc = window.location.origin;
  $("base").value = loc;
  ping();
})();
</script>
</body>
</html>
